<?php
 include("../../config/settings.inc.php");
 $network = isset($_GET['network']) ? $_GET["network"] : 'IA_ASOS';
 $metar = isset($_GET['metar']) ? $_GET["metar"] : "no";
 $sortcol = isset($_GET['sortcol'])  ? $_GET['sortcol']: "ts";
 $sorder = isset($_GET['sorder']) ? $_GET['sorder']: "desc";
?>

<?php
  $TITLE = "IEM | ASOS | Current Conditions";
  $REFRESH = "<meta http-equiv=\"refresh\" content=\"1200;\">";
  $HEADEXTRA = '<script language="JavaScript" type="text/javascript">
<!--//BEGIN Script
function new_window(url) {
 link = window.open(url,"_new","toolbar=0,location=0,directories=0,status=0,menubar=no,scrollbars=yes,resizable=yes,width=800,height=600");
} 
//END Script-->
</script>
';
 $THISPAGE = "current-sort";
  include("$rootpath/include/header.php"); 
  include("$rootpath/include/mlib.php"); 
  include("$rootpath/include/network.php");
  $nt = new NetworkTable($network);
  $cities = $nt->table;
  include("$rootpath/include/iemaccess.php");
  include("$rootpath/include/iemaccessob.php");

$iem = new IEMAccess();
$asos = $iem->getNetwork($network);


$vals = Array("tmpf" => "Air Temperature [F]", "dwpf" => "Dew Point Temp [F]",
  "sknt" => "Wind Speed [knots]", "drct" => "Wind Direction [deg]",
  "alti" => "Altimeter [mb]", "peak" => "Today's Wind Gust [knots]",
  "peak_ts" => "Time of Peak Gust", "relh" => "Relative Humidity",
  "feel" => "Feels Like [F]", "vsby" => "Visibility [miles]",
  "ts" => "Observation Time", "phour" => "Last Hour Rainfall [inch]",
  "min_tmpf" => "Today's Low Temperature", "sname" => "Station Name",
  "max_tmpf" => "Today's High Temperature",
  "skyl1" => "Cloud Level 1",
  "skyl2" => "Cloud Level 2",
  "skyl3" => "Cloud Level 3",
  "skyl4" => "Cloud Level 4",
  "pday" => "Today Rainfall [inch]", );

?>


<?php $current_network = "ASOS"; include("$rootpath/include/current_bar.inc.php"); ?>
<h3 class="subtitle">ASOS Conditions</h3><p>
<table border=1 cellspacing=0 cellpadding=1>
<tr>
  <th>View Options:</th>
  <td>
<form method="GET" action="current.phtml">
<input type="hidden" name="sortcol" value="<?php echo $sortcol; ?>">
Select State:<select name="network">
 <option value="AL_ASOS" <?php if ($network == "AL_ASOS") echo "SELECTED"; ?>>Alabama
 <option value="AK_ASOS" <?php if ($network == "AK_ASOS") echo "SELECTED"; ?>>Alaska
 <option value="AR_ASOS" <?php if ($network == "AR_ASOS") echo "SELECTED"; ?>>Arkansas
 <option value="AZ_ASOS" <?php if ($network == "AZ_ASOS") echo "SELECTED"; ?>>Arizona
 <option value="CA_ASOS" <?php if ($network == "CA_ASOS") echo "SELECTED"; ?>>California
 <option value="CO_ASOS" <?php if ($network == "CO_ASOS") echo "SELECTED"; ?>>Colorado
 <option value="CT_ASOS" <?php if ($network == "CT_ASOS") echo "SELECTED"; ?>>Connecticut
 <option value="DE_ASOS" <?php if ($network == "DE_ASOS") echo "SELECTED"; ?>>Delaware
 <option value="FL_ASOS" <?php if ($network == "FL_ASOS") echo "SELECTED"; ?>>Florida
 <option value="GA_ASOS" <?php if ($network == "GA_ASOS") echo "SELECTED"; ?>>Georgia
 <option value="HI_ASOS" <?php if ($network == "HI_ASOS") echo "SELECTED"; ?>>Hawaii
 <option value="ID_ASOS" <?php if ($network == "ID_ASOS") echo "SELECTED"; ?>>Idaho
 <option value="IL_ASOS" <?php if ($network == "IL_ASOS") echo "SELECTED"; ?>>Illinois
 <option value="IN_ASOS" <?php if ($network == "IN_ASOS") echo "SELECTED"; ?>>Indiana
 <option value="IA_ASOS" <?php if ($network == "IA_ASOS") echo "SELECTED"; ?>>Iowa
 <option value="KS_ASOS" <?php if ($network == "KS_ASOS") echo "SELECTED"; ?>>Kansas
 <option value="KY_ASOS" <?php if ($network == "KY_ASOS") echo "SELECTED"; ?>>Kentucky
 <option value="LA_ASOS" <?php if ($network == "LA_ASOS") echo "SELECTED"; ?>>Louisana
 <option value="MN_ASOS" <?php if ($network == "MN_ASOS") echo "SELECTED"; ?>>Maine
 <option value="MD_ASOS" <?php if ($network == "MD_ASOS") echo "SELECTED"; ?>>Maryland
 <option value="MA_ASOS" <?php if ($network == "MA_ASOS") echo "SELECTED"; ?>>Massachusetts
 <option value="MI_ASOS" <?php if ($network == "MI_ASOS") echo "SELECTED"; ?>>Michigan
 <option value="MN_ASOS" <?php if ($network == "MN_ASOS") echo "SELECTED"; ?>>Minnesota
 <option value="MS_ASOS" <?php if ($network == "MS_ASOS") echo "SELECTED"; ?>>Mississippi
 <option value="MO_ASOS" <?php if ($network == "MO_ASOS") echo "SELECTED"; ?>>Missouri
 <option value="MT_ASOS" <?php if ($network == "MT_ASOS") echo "SELECTED"; ?>>Montana
 <option value="NE_ASOS" <?php if ($network == "NE_ASOS") echo "SELECTED"; ?>>Nebraska
 <option value="NH_ASOS" <?php if ($network == "NH_ASOS") echo "SELECTED"; ?>>New Hampshire
 <option value="NC_ASOS" <?php if ($network == "NC_ASOS") echo "SELECTED"; ?>>North Carolina
 <option value="ND_ASOS" <?php if ($network == "ND_ASOS") echo "SELECTED"; ?>>North Dakota
 <option value="NV_ASOS" <?php if ($network == "NV_ASOS") echo "SELECTED"; ?>>Nevada
 <option value="NH_ASOS" <?php if ($network == "NH_ASOS") echo "SELECTED"; ?>>New Hampshire
 <option value="NJ_ASOS" <?php if ($network == "NJ_ASOS") echo "SELECTED"; ?>>New Jersey
 <option value="NM_ASOS" <?php if ($network == "NM_ASOS") echo "SELECTED"; ?>>New Mexico
 <option value="NY_ASOS" <?php if ($network == "NY_ASOS") echo "SELECTED"; ?>>New York
 <option value="OH_ASOS" <?php if ($network == "OH_ASOS") echo "SELECTED"; ?>>Ohio
 <option value="OK_ASOS" <?php if ($network == "OK_ASOS") echo "SELECTED"; ?>>Oklahoma
 <option value="OR_ASOS" <?php if ($network == "OR_ASOS") echo "SELECTED"; ?>>Oregon
 <option value="PA_ASOS" <?php if ($network == "PA_ASOS") echo "SELECTED"; ?>>Pennsylvania
 <option value="RI_ASOS" <?php if ($network == "RI_ASOS") echo "SELECTED"; ?>>Rhode Island
 <option value="SC_ASOS" <?php if ($network == "SC_ASOS") echo "SELECTED"; ?>>South Carolina
 <option value="SD_ASOS" <?php if ($network == "SD_ASOS") echo "SELECTED"; ?>>South Dakota
 <option value="TN_ASOS" <?php if ($network == "TN_ASOS") echo "SELECTED"; ?>>Tennessee
 <option value="TX_ASOS" <?php if ($network == "TX_ASOS") echo "SELECTED"; ?>>Texas
 <option value="UT_ASOS" <?php if ($network == "UT_ASOS") echo "SELECTED"; ?>>Utah
 <option value="VT_ASOS" <?php if ($network == "VT_ASOS") echo "SELECTED"; ?>>Vermont
 <option value="VA_ASOS" <?php if ($network == "VA_ASOS") echo "SELECTED"; ?>>Virginia
 <option value="WA_ASOS" <?php if ($network == "WA_ASOS") echo "SELECTED"; ?>>Washington
 <option value="WV_ASOS" <?php if ($network == "WV_ASOS") echo "SELECTED"; ?>>West Virginia
 <option value="WI_ASOS" <?php if ($network == "WI_ASOS") echo "SELECTED"; ?>>Wisconsin
 <option value="WY_ASOS" <?php if ($network == "WY_ASOS") echo "SELECTED"; ?>>Wyoming
 <option value="IQ_ASOS" <?php if ($network == "IQ_ASOS") echo "SELECTED"; ?>>Iraq/Afganistan Military
 <option value="PO_ASOS" <?php if ($network == "PO_ASOS") echo "SELECTED"; ?>>Pacific Ocean
</select></td>
  <td>Include METARS:
  <input value="no" type="radio" name="metar" <?php if ($metar == "no") echo  "CHECKED"; ?>> No
  <input value="yes" type="radio" name="metar" <?php if ($metar == "yes") echo  "CHECKED"; ?>> Yes
</td>
<td>Sort Order:
<select name="sorder">
  <option value="asc" <?php if ($sorder == "asc") echo "SELECTED"; ?>>Ascending
  <option value="desc" <?php if ($sorder == "desc") echo "SELECTED"; ?>>Decending
</select></td>
<td><input type="submit" value="Go!"></form></td>
</tr></table>




<?php
echo "<br>Times are in CST/CDT. Table sorted by: <b>(". $vals[$sortcol] .")</b>  &nbsp; &nbsp; Click on
a column to sort it.<br>\n";
?>

<form method="GET" action="<?php echo $rooturl; ?>/my/current.phtml">


<?php $uri = "current.phtml?sorder=$sorder&metar=$metar&network=$network&sortcol="; ?>

<table style="width: 100%; font-size: 10pt;" cellspacing=0 cellpadding=1 border=1>
<thead>
<tr>
  <th rowspan="2">ADD:</th>
  <th rowspan="2"><a href="<?php echo $uri; ?>sname">Station</a></th>
  <th rowspan="2"><a href="<?php echo $uri; ?>ts">Ob Time</a></th>
  <th colspan="5">Temps &deg;F</th>
  <th colspan="3">&nbsp;</th>
  <th colspan="3">Wind [knots]</th>
  <th colspan="2">Precip</font></th>
  <th colspan="4">Clouds</font></th>
<tr>
  <th><a href="<?php echo $uri; ?>tmpf">Air</a></th>
  <th><a href="<?php echo $uri; ?>max_tmpf">Hi</a></th>
  <th><a href="<?php echo $uri; ?>min_tmpf">Lo</a></th>
  <th><a href="<?php echo $uri; ?>dwpf">Dewp</a></th>
  <th><a href="<?php echo $uri; ?>feel">Feels</a></th>
  <th><a href="<?php echo $uri; ?>relh">RH %</a></th>
  <th><a href="<?php echo $uri; ?>alti">Alti</a></th>
  <th><a href="<?php echo $uri; ?>vsby">Vsby</a></th>
  <th><a href="<?php echo $uri; ?>sknt">Speed</a></th>
  <th><a href="<?php echo $uri; ?>drct">Drct</a></th>
  <th><a href="<?php echo $uri; ?>peak">Gust</a>
    @ <a href="<?php echo $uri; ?>peak_ts">Time</a></th>
  <th><a href="<?php echo $uri; ?>phour">1 Hour</a></th>
  <th><a href="<?php echo $uri; ?>pday">Today</a></th>
  <th><a href="<?php echo $uri; ?>skyl1">Level 1</a></th>
  <th><a href="<?php echo $uri; ?>skyl2">Level 2</a></th>
  <th><a href="<?php echo $uri; ?>skyl3">Level 3</a></th>
  <th><a href="<?php echo $uri; ?>skyl4">Level 4</a></th>
</tr></thead>
<tbody>
<?php
function aSortBySecondIndex($multiArray, $secondIndex, $sorder) {
  while (list($firstIndex, ) = each($multiArray))
       $indexMap[$firstIndex] = $multiArray[$firstIndex][$secondIndex];
  if ($sorder == "asc")
        asort($indexMap);
  else 
        arsort($indexMap);
  while (list($firstIndex, ) = each($indexMap))
      if (is_numeric($firstIndex))
                 $sortedArray[] = $multiArray[$firstIndex];
      else $sortedArray[$firstIndex] = $multiArray[$firstIndex];
  return $sortedArray;
}

/* Final data array */
$mydata = Array();

while ( list($key, $iemob) = each($asos) ){
    $mydata[$key] = $iemob->db;
    $mydata[$key]["ts"] = $iemob->ts;
    $mydata[$key]["sname"] = $cities[$key]["name"];
    $mydata[$key]["sped"] = $mydata[$key]["sknt"] * 1.15078;
    $mydata[$key]["relh"] = relh(f2c($mydata[$key]["tmpf"]), 
       f2c($mydata[$key]["dwpf"]) );
    $mydata[$key]["feel"] = feels_like($mydata[$key]["tmpf"], 
       $mydata[$key]["relh"], $mydata[$key]["sped"]);
    if ($mydata[$key]["max_gust"] > $mydata[$key]["max_sknt"]){
      $mydata[$key]["peak"] = $mydata[$key]["max_gust"];
      $mydata[$key]["peak_ts"] = strtotime(substr( $mydata[$key]["max_gust_ts"],0,16) );
    } else {
      $mydata[$key]["peak"] = $mydata[$key]["max_sknt"];
      if ($mydata[$key]["max_sknt_ts"] > 0) {
         $mydata[$key]["peak_ts"] = strtotime(substr( $mydata[$key]["max_sknt_ts"],0,16) );
      }
    }

} // End of while


$finalA = aSortBySecondIndex($mydata, $sortcol, $sorder);
$now = time();
$i = 0;
$old = "";
while (list ($key, $val) = each ($finalA))  {
  $i++;
  $parts = $finalA[$key];

  $row = "<tr";
  if ($i % 2 == 0)  $row .= " bgcolor='#eeeeee'";  
  $row .= "><td><input type=\"checkbox\" name=\"st[]\" value=\"".$key."\"></td>";

  $tdiff = $now - $asos[$key]->ts;
  $url = sprintf("%s/sites/site.php?station=%s&network=%s", $rooturl,
         $key, $network);
  $row .= "<td>". $cities[$key]["name"] . " (<a href=\"$url\">${key}</a>)</td>";
  $row .= "<td ";
  if ($tdiff > 10000){
    $fmt = "%d %b %I:%M %p";
    $row .= "bgcolor=\"red\">". strftime($fmt, $asos[$key]->ts) ."</td><td colspan=\"16\">Site Offline</td></tr>";
    $old .= $row;
    continue;
  } else if ($tdiff > 7200){
    $fmt = "%I:%M %p";
    $row .= 'bgcolor="orange"';
  } else if ($tdiff > 3600){
    $fmt = "%I:%M %p";
    $row .= 'bgcolor="green"';
  } else {
    $fmt = "%I:%M %p";
  }
  $row .= ">". strftime($fmt, $asos[$key]->ts) ."</td>
   <td align='center'>". round($parts["tmpf"],0) ."</td><td><font color=\"#ff0000\">". round($parts["max_tmpf"],0) ."</font></td><td><font color=\"#0000ff\">". round($parts["min_tmpf"],0) ."</font></td>
     <td>". round($parts["dwpf"],0) ."</td>
     <td>". round($parts["feel"],0) ."</td>
	    <td>". $parts["relh"] ."</td>
	    <td>". $parts["alti"] ."</td>
	    <td>". $parts["vsby"] ."</td>
             <td>". round($parts["sknt"],0) ;

   if (floatval($parts["gust"] > 0)){
      $row .= "G". round($parts["gust"],0);
   } $row .= "</td>";
   $row .= "<td>". drct2txt( $parts["drct"] ) ."</td><td>";
  if (isset($parts["peak_ts"])) $row .=  $parts["peak"] ." @ ". strftime("%I:%M %p", $parts["peak_ts"]) ;
  $row .= "</td><td>". $parts["phour"] ."</td>
            <td>". $parts["pday"] ."</td>
<td>". $parts["skyc1"] ." ". $parts["skyl1"] ."</td>
<td>". $parts["skyc2"] ." ". $parts["skyl2"] ."</td>
<td>". $parts["skyc3"] ." ". $parts["skyl3"] ."</td>
<td>". $parts["skyc4"] ." ". $parts["skyl4"] ."</td>
	    </tr>\n";
  if ($metar == "yes") {
    $row .= "<tr";
    if ($i % 2 == 0)  $row .= " bgcolor='#eeeeee'";
    $row .= ">";
    $row .= "<td colspan=\"20\">
             <font color=\"brown\">". $parts["raw"] ."</font></td>
             </tr>\n";
   }
  echo $row;
 }
echo $old;

 $uri = "javascript:new_window('$rooturl/GIS/apps/php/currents.phtml?layers[]=radar&layers[]=labels&network=$network";
?>
</tbody>
<tfoot>
<tr>
 <td colspan="3">&nbsp;</td>
 <td><a href="<?php echo $uri; ?>&var=tmpf');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=max_tmpf');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=min_tmpf');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=dwpf');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=feel');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=relh');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=alti');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=vsby');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=sknt');">Plot</a></td>
 <td>&nbsp;</td>
 <td><a href="<?php echo $uri; ?>&var=max_gust');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=phour');">Plot</a></td>
 <td><a href="<?php echo $uri; ?>&var=pday');">Plot</a></td>
 <td></td>
 <td></td>
 <td></td>
 <td></td>
</tr></tfoot>
</table>

<input type="submit" value="Add to Favorites">
<input type="reset" value="Reset">

</form>


<?php include("$rootpath/include/footer.php"); ?>
