MAP
#
# Start of map file
#
NAME IAoverlay
STATUS ON
SIZE 640 480
#SYMBOLSET symbols/symbol.sym
FONTSET "/mesonet/data/gis/fonts/fonts.list"
EXTENT 200000 4400000 710000 4900000
UNITS METERS
SHAPEPATH "/mesonet/data/gis/"
SYMBOLSET "/mesonet/data/gis/symbols/stations.sym"
IMAGECOLOR 250 250 250
IMAGETYPE PNG
TRANSPARENT off
INTERLACE off

#
# Projection definition, consult the PROJ.4 documentation for parameter discussion
#
PROJECTION
  "init=epsg:26915"
END

#
# Start of web interface definition
#
WEB
  HEADER ia_header.html
  TEMPLATE ia.html
  FOOTER ia_footer.html
  MINSCALE 9000
  MAXSCALE 3000000
  IMAGEPATH "/var/www/htdocs/tmp/"
  IMAGEURL "/tmp/"
  LOG "/var/www/htdocs/tmp/IAoverlay.log"
END


SCALEBAR
  IMAGECOLOR 250 250 250
  LABEL
    COLOR 0 0 0
    SIZE tiny
  END
  STYLE 1
  SIZE 50 2
  COLOR 0 0 0
  UNITS MILES
  INTERVALS 1
  TRANSPARENT TRUE
  STATUS TRUE
END

#
#

#
# Start of layer definitions
#

LAYER
  NAME radar
  DATA /mesonet/data/gis/images/26915/IOWA_N0R.png
  TYPE RASTER
  STATUS on
  PROJECTION
    "init=epsg:26915"
  END
  OFFSITE 0 0 0
  TRANSPARENCY 70
END

# Layer for County Boundaries
LAYER
  NAME counties
  TYPE POLYGON
  DATA /mesonet/data/gis/static/shape/26915/iowa/iacounties.shp
  STATUS DEFAULT
  LABELITEM "CO_NAME"
  LABELMAXSCALE 1000
  PROJECTION
   "init=epsg:26915"
  END
  CLASS
    #NAME 'County Boundaries'
    OUTLINECOLOR 181 181 145
    LABEL
      COLOR 0 0 0
      SHADOWCOLOR 218 218 218
      SHADOWSIZE 2 2
      TYPE BITMAP
      SIZE MEDIUM
      POSITION AUTO
      PARTIALS FALSE
      BUFFER 2
    END
  END
END

LAYER
  CONNECTIONTYPE postgis
  NAME sid
  CONNECTION "user=nobody dbname=iem host=iemdb"
  DATA "geom from (select geom, station, 
    oid from current WHERE (valid > CURRENT_TIMESTAMP - '2 hours'::interval)
    ) as foo using unique oid using srid=4326"
  STATUS ON
  TYPE POINT
  LABELCACHE ON
  PROJECTION
   "init=epsg:4326"
  END
  #FILTER "valid > 'TODAY'"
  CLASS
    TEXT ([ station ])
    LABEL
      COLOR 180 180 180
      TYPE BITMAP
      SIZE SMALL
      POSITION CR
      OFFSET 5 0
      BUFFER 2
      PARTIALS TRUE
      FORCE TRUE
    END      
  END
END

LAYER
  CONNECTIONTYPE postgis
  NAME ts
  CONNECTION "user=nobody dbname=iem host=iemdb"
  DATA "geom from (select geom, to_char(valid, 'HH24:MI') as tvalid,
    oid from current WHERE (valid > CURRENT_TIMESTAMP - '2 hours'::interval)
    ) as foo using unique oid using srid=4326"
  STATUS ON
  TYPE POINT
  LABELCACHE ON
  PROJECTION
   "init=epsg:4326"
  END
  CLASS
    TEXT ([ tvalid ])
    LABEL
      COLOR 180 180 180
      TYPE BITMAP
      SIZE SMALL
      POSITION UR
      OFFSET 5 2
      BUFFER 2
      PARTIALS TRUE
      FORCE TRUE
    END      
  END
END



LAYER
  CONNECTIONTYPE postgis
  NAME tmpf
  # Connect to a remote spatial database
  CONNECTION "user=nobody dbname=iem host=iemdb"
  # Get the lines from the 'geom' column of the 'roads' table
  DATA "geom from (select geom, tmpf, 
    oid from current WHERE (valid > CURRENT_TIMESTAMP - '2 hours'::interval)
    and tmpf between -50 and 120) as foo using unique oid using srid=4326"
  STATUS ON
  TYPE POINT
  LABELCACHE ON
  PROJECTION
   "init=epsg:4326"
  END
  CLASS
    TEXT ([ tmpf ])
    COLOR -1 -1 -1
    LABEL
      COLOR 255 0 0
      TYPE BITMAP
      SIZE MEDIUM
      POSITION UL
      OFFSET 2 2
      BUFFER 0
      PARTIALS TRUE
      FORCE TRUE
    END      
  END
END

LAYER
  CONNECTIONTYPE postgis
  NAME dwpf
  # Connect to a remote spatial database
  CONNECTION "user=nobody dbname=iem host=iemdb"
  # Get the lines from the 'geom' column of the 'roads' table
  DATA "geom from (select geom, dwpf,
    oid from current WHERE (valid > CURRENT_TIMESTAMP - '2 hours'::interval)
    and dwpf between -60 and 100) as foo using unique oid using srid=4326"
  STATUS ON
  TYPE POINT
  LABELCACHE ON
  PROJECTION
   "proj=latlong"
  END
  CLASS
    # Make the superhighways brighter and 2 pixels wide
  #  EXPRESSION ([tmpf] >= 6)
    TEXT ([dwpf])
    COLOR -1 -1 -1
    LABEL
      SIZE MEDIUM
      COLOR 0 0 250
      BACKGROUNDCOLOR -1 -1 -1
      TYPE BITMAP
      BUFFER 4
      FORCE TRUE
      OFFSET 2 2
      POSITION LL
    END
  END
END

LAYER
  CONNECTIONTYPE postgis
  NAME sknt
  # Connect to a remote spatial database
  CONNECTION "user=nobody dbname=iem host=iemdb"
  DATA "geom from (select geom, sknt, 
    oid from current WHERE (valid > CURRENT_TIMESTAMP - '2 hours'::interval)
    and sknt between 0 and 100) as foo using unique oid using srid=4326"
  STATUS ON
  TYPE POINT
  LABELCACHE ON
  # Of the lines in the extents, only render the wide highways
  PROJECTION
   "proj=latlong"
  END
  CLASS
    # Make the superhighways brighter and 2 pixels wide
  #  EXPRESSION ([tmpf] >= 6)
    TEXT ([sknt])
    COLOR -1 -1 -1
    LABEL
      SIZE MEDIUM
      COLOR 132 31 31
      BACKGROUNDCOLOR -1 -1 -1
      TYPE BITMAP
      BUFFER 4
      OFFSET 2 2
      FORCE TRUE
    END
  END
END


LAYER
  CONNECTIONTYPE postgis
  NAME barbs
  # Connect to a remote spatial database
  CONNECTION "user=nobody dbname=iem host=iemdb"
  # Get the lines from the 'geom' column of the 'roads' table
  DATA "geom from (select geom, 
    case WHEN sknt between 0 and 4.99 THEN chr(227)
       WHEN sknt between 5 and 9.99   THEN chr(228)
       WHEN sknt between 10 and 14.99 THEN chr(229)
       WHEN sknt between 15 and 19.99  THEN chr(230)
       WHEN sknt between 20  and 24.99 THEN chr(231)
       WHEN sknt between 25  and 29.99 THEN chr(232)
       WHEN sknt between 30  and 34.99 THEN chr(233)
       WHEN sknt between 35  and 39.99 THEN chr(234)
       WHEN sknt between 40  and 44.99 THEN chr(235)
       WHEN sknt between 45  and 49.99 THEN chr(236)
       ELSE chr(1) END as sknt,
    (0 - drct) as drct, oid from current WHERE sknt > 0 
    and valid > 'TODAY' and sknt IS NOT NULL) as foo using unique oid using srid=4326"
  STATUS ON
  TYPE POINT
  LABELANGLEITEM drct
  LABELCACHE OFF
  PROJECTION
   "proj=latlong"
  END
  CLASS
    TEXT ([sknt])
    COLOR -1 -1 -1
    LABEL
        COLOR 0 0 0
        TYPE truetype
        FONT weather
        SIZE 45
        POSITION UR
        OFFSET -4 -5 # for size 30 UR
        BUFFER 0
        PARTIALS TRUE
    END
  END
END

END
